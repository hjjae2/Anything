## Stream API

**스트림이란? 한 번에 한 개씩 만들어지는 연속적인 데이터 항목들의 모임이다. **

> 이론적으로 프로그램은 입력 스트림에서 데이터를 1개씩 읽어 들이고 출력 스트림으로 1개씩 기록한다. 어떤 프로그램의 출력 스트림은 다른 프로그램의 입력 스트림이 될 수 있다.

자바 8에는 `java.util.stream` 패키지에 `Stream API` 가 추가되었다.

Stream API 는 파이프라인을 만드는 데 필요한 많은 메서드를 제공한다. **Stream API 의 핵심은 데이터베이스 질의 처럼 고수준으로 추상화해서 처리할 수 있다는 것이다.** 또, 파이프라인을 이용해서 입력 부분을 여러 CPU 코어에게 쉽게 할당할 수 있다. Thread 라는 복잡한 기능을 사용하지 않아도 **병렬성** 을 얻을 수 있다.

예컨대 자바에서는 많은 양의 데이터를 처리할 때, 컬렉션이나 배열을 사용한다. 이러한 컬렉션이나 배열을 처리할 때에는 반복문(loop), 반복자(iterator) 를 사용한다. 반목문이나 반복자의 사용은 코드를 재사용용할 수 없다는 특징이 있다. (예를 들어, 어떤 처리를 하기 위해서 매번 새로운 코드(loop, iteraotor)를 작성했을 것이다.)

Stream API 를 통해 위의 문제점을 극복할 수 있다. 위에서 언급했듯이 Stream API 는 데이터를 추상화하여 다루므로, 다양한 형태로 저장된 데이터를 공통된 방법으로 연산할 수 있다.

> \* 위에서 언급된 '데이터의 추상화'란, 데이터가 무엇이든 같은 방식으로 다룰 수 있다는 것을 의미한다.

<br>

### Stream API 의 특징은 다음과 같다.

1. **내부 반복(internal interation) 을 통해 작업을 수행한다.**
2. 재사용이 가능한 컬렉션/배열과 달리 한 번만 사용할 수 있다. **(\* 스트림은 일회용이다.)**
3. **원본 데이터(original data)를 변경하지 않는다.**
4. Filter-Map 기반의 API를 사용 -> **Lazy 연산을 통해 성능을 최적화한다.** (?)
5. `parallelStream()` 메서드를 통해 손쉬운 병렬 처리를 지원한다.
6. **(1)스트림의 생성 - (2)스트림의 중개 연산(스트림의 변환 : filter, map, ...) - (3)스트림의 최종 연산(스트림 사용, 스트림 요소 소모 : reduce, collect, ...) 의 단계로 동작한다.**

**\* 스트림으로 연산(중개연산, 최종연산)을 할 때 대부분 '함수형 인터페이스 매개변수'를 갖는 것을 알 수 있다. 즉, 람다식을 사용할 수 있다.**

<br>

### 병렬 스트림

Stream API 에는 '병렬 스트림'을 생성할 수 있는 API 를 제공한다. 

병렬 스트림이란, 각각의 스레드에서 처리할 수 있도록 Stream 의 요소(element)를 여러 chunk 로 분할한 스트림이다. 이 chunk 를 멀티코어 CPU 가 처리하도록 할당할 수 있다. (\* 병렬 스트림은 내부적으로 `ForkJoinPool` 을 사용한다.)

\* 병렬 처리가 항상 향상된 성능으로 동작하는 것은 아니다.

\* 어떤 알고리즘을 병렬화 하는 것보다 어떤 자료구조를 선택할 지 고민하는 것이 중요하기도 하다. (예를 들어, 불필요한 박싱/언박싱 제거)

많은 글들에서 스트림은 "내부 반복" 을 통해 병렬 처리를 쉽게할 수 있다고 한다. 그렇다면 왜 내부 반복을 사용하면 병렬 처리를 쉽게 할 수 있을까? 내가 생각한 결론은 "병렬 처리를 위해 요소들을 chunk 단위로 분할할 때, 개발자가 직접 분할하지 않고 내부에서 알아서 분할해줄 수 있기 때문에" 이다.

<br>

**병렬 처리를 할 때 아래의 것들에 대해 고려해봐야 한다.**

병렬 처리의 동작 방식에 대해 정확히 알고 사용하자.

멀티코어 간의 데이터 이동 비용과 작업(로직)의 비용을 비교하자.

공유 자원이 연관된 작업에 대해서는 병렬화의 이점이 없을 수 있다. (공유 자원에 대해 관계가 없을 때 사용하는 것이 바람직하다.)

전체 스트림 파이프라인 처리 비용 = N * Q (N = 처리해야할 요소의 수, Q = 하나의 요소를 처리할 때 발생하는 비용)일 때, Q 가 높다면 병렬 스트림으로 성능을 개선할 수 있는 가능성이 있다. (N 이 커도 개선할 수 있는 가능성이 있다.)

'최종 연산' 의 병합 비용을 고려한다.<br>
- 병합 비용이 비싸다면, 이득이 없을 수 있다.

소량의 데이터에서는 병렬 스트림의 이득이 크지 않다.

<br>

### Fork/Join Framework (포크/조인 프레임워크) 란 ?

Fork/Join 프레임워크는 작업을 작은 작업으로 분할하고, (sub task)각각의 결과를 합쳐 전체 결과를 만들도록 설계되었다.

서브태스크(sub task)를 ForkJoinPool의 작업 스레드에 분산하여 할당하는 ExcutorService 인터페이스를 구현한다.


> 스트림 API, http://tcpschool.com/java/java_stream_concept<br>
> 병렬 데이터 처리와 성능(병렬 스트림), https://yongho1037.tistory.com/705